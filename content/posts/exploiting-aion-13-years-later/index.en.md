---
title: "Ghost in the house"
subtitle: "Getting RCE on AION client, 13 years later"
date: 2025-08-23T00:23:00+01:00
authors: ["himazawa"]
draft: true
tags: []
featuredImage: res/aion_logo.png
categories: [blog-news]
---

When I was younger, MMOs were everywhere. World of Warcraft had already taken over the world with millions of players, Lineage II and Runescape had their own massive communities, and when AION launched in 2009 by NCSoft (a South Korean Company) it quickly became one of the most pupulated MMOs, with around 6 millions players in Asia and 1 million in Europe. 

But honestly the 10 years-old me never really got into it. My thing was mainly FPS. I’d rather be playing Halo 3 or Call of Duty matches than grinding dungeons and raids.

Few weeks ago tho, some of my friends decided to give AION another go, this time on a private server. 
For anyone unfamiliar, private servers are unofficial versions of the game run by the community. They invited me to join them, and that’s how I finally ended up in AION.

Except, instead of just playing, I got curious about how things worked behind the scenes, which eventually led me to uncover a vulnerability hidden in the original client itself.

## The housing system

In version 3.0 c(2011) NCSoft added the Housing system to the game, basically each player can  buy a house that can customize it with forniture. Another interesting feature is this guy:

![butler]

This NPC is the Butler. It allows you to manage the foniture and to access the scripting system.
With this system players can write scripts to play sounds and automate actions that will happen inside the house. 
The documentation on this in-game editor is close to non-existent so I tried my best to work around it.
Luckily the game provide some pre-populated scripts so I use them to get an idea on what I was working with.

{{< figure src="res/scripting_system.png" title="In-game script editor" >}}

## stdout or stdbutler?

Looking at the script source it looks like they are using some version of Lua, but we are in a sandbox and trying to use some basic functions doesn't work.

An example of script pre-loaded is this one that Greet the each player that enters in the range of the NPC (some pieces are redacted for ease of reading):

```lua
...
function GetHelloString(desc)
    if (helloTable[desc] == nil) then
        return desc.."[kvalue:Default greeting;, Hello, dear.;str]";
    end
        return helloTable[desc][1];
end

function GetHelloSound(desc)
    ...
end

-- Called on function initialization.
function OnInit()

    -- With the SetSensor command, you can customize the distance the butler recognizes a user.
    -- The butler recognizes the user inside the radius of the first variable.
    -- The butler does not respond if the user is outside the second variable.
    -- For the following code, the butler recognizes a user when he/she comes within a 3m radius.
    -- Again, the butler does not respond when a user passes a 30m radius.
    H.SetSensor(3, 30);

end

-- Calls when a user enters a distance range that the butler can recognize.
function OnUserEntered(desc)

    -- With the PlaySound command, options can be set to play music or a label.
    -- The first variable is to set channels and the second one sets music score.
    -- This line sets 2 labels for channel no. 0.
    H.PlaySound(0, "r[1]r[2]");

    -- Play the effect sound for the respective visitors.
    if (GetHelloSound(desc) ~= nil) then
        -- The SetPercussion command is used for customizing sounds.
        H.SetPercussion(1, GetHelloSound(desc));
        -- "x" refers to SetPercussion, enabling the preset sound.
        H.PlaySound(1, "x");
    end

    -- The butler speaks through a speech bubble.
    -- The first variable "2" refers to the label no. [2] in the PlaySound command.
    -- Enter the dialog message of the butler in the second variable.
    H.Say(2, GetHelloString(desc));
end
```

The assumption here is that we are in a sort of lua sandbox with some functions disabled: this is pretty common in games that allow customization and the language is besically it.

For those unfamiliar with lua, it's an intepreted language with high extensibilities.

Global variables and functions are contained in the global table `_G` so my idea was to loop over the elements and check what I have access to, since again, there is no documentation.


The `print` function is disabled and the same is if we try to write to stderr, even if there is an output box, I discovered that the only way to write there is using the `error` function, but this will make the program exit so it will make everything harder.

Reading one of the script that came with the butler, I saw that `H.Say()` is used to make the NPC send messages, so I decided to leverage this function to get my output.

The first script to enumerate the function is this:

```lua
-- This is a core function and starts when the house script is initialized.j  
function OnInit()
-- This registers a voice in the menu
   H.RegisterMenu("bing bong", 3);
end

-- If user select a voice in the menu
function OnMenu(menuNum)
--- If the voice is not 3 (our command) go out
  if (menuNum ~= 3) then
    return;
  end
   -- Calling H.PlaySound() is somehow necessary before calling H.Say(), otherwise the NPC won't speak
   -- No idea why, I just figured it out with trial and error and reading the pre-existing scripts
   H.PlaySound(0, "r[1]");
   local env = _G
   H.Say(1,"=== DUMPING ".. "_G ===");
   local result = ""
        -- Iterate the table
        for k, v in pairs(env) do
          result = result .. tostring(k) .. " = " .. tostring(v) .. "\n"
          -- Use butler as stdout
          H.Say(1,tostring(k).." = " .. tostring(v));
        end
        
end
```

And with my great surprise it worked:

{{< figure src="res/stdbutler.png" title="He's speaking the language of the interpreter" >}}

## Reaching code execution

Apparently the sandbox is very losely configured and we have access to _a lot_ of functions that allows code execution. 
Among those we have: `loadstring`, `loadfile`, `load`    and `io`

There is a very interesting article about memory corruptions in lua applied in particular to games that basically explains how
